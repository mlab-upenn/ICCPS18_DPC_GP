\section{Case Study}
\label{S:casestudy}

\todo[inline]{intro part taken directly from CDC}

In January 2014, the east coast (PJM) electricity grid experienced an 86x increase in the price of electricity from \$31/MWh to \$2,680/MWh in a matter of 10 minutes. Similarly, the price spiked 32x from an average of \$25/MWh to \$800/MWh in July of 2015. This extreme price volatility has become the new norm in our electric grids. Building additional peak generation capacity is not environmentally or economically sustainable. Furthermore, the traditional view of energy efficiency does not address this need for \emph{Energy Flexibility}. The solution lies with Demand Response (DR) from the customer side - curtailing demand during peak capacity for financial incentives. However, this is a very hard problem for commercial, industrial and institutional plants, the largest electricity consumers.

Thus, the problem of energy management during a DR event makes an ideal case for DPC. In the following sections, we apply Optimal Experiment Design, DPC based on GPs and also perform Active Learning on a large scale EnergyPlus model to show how effectively DPC can provide a desired power curtailment as well as a desired thermal comfort. DPC builds predictive models of a building based on historical weather, schedule, set-points and electricity consumption data, while also learning from the actions of the building operator. These models are then used for synthesizing recommendations about the control actions that the operator needs to take, during a DR event, to obtain a given load curtailment while providing guarantees on occupant comfort and operations.

\subsection{Building Description}
\todo[inline]{check LargeOffice or LargeHotel}
We use the DoE Commercial Reference Building (DoE CRB) simulated in EnergyPlus \cite{Deru2011} as the virtual test-bed building.
This is a large 6 story hotel building consisting of 22 zones with a total area of 122,120 sq.ft. 
During peak load conditions the building can consume up to 400 kW of power. 

In this case study, we use the following data to validate our results. We limit to data which can be measured directly from installed sensors like thermostats, multimeters and weather forecasts., thus making it scalable to any other building or a campus of buildings.

\textit{Weather variables \(d^w\):} outside temperature and humidity - these features are defined in a weather file in EnergyPlus.

\textit{Proxy features \(d^p\):} time of day, day of week - these features are a good indicator of occupancy and periodic trends.

\textit{Fixed schedules  \(d^s\):} kitchen cooling set point, corridor cooling set point - these set points follow predefined rules. 

\textit{Control variables \(u\):} cooling set point, supply air temperature and chilled water set point - these set points will be optimized in the MPC problem for Power Tracking Reference Control in Sec.~\ref{SS:power_tracking} and Optimal Energy Management in Sec.~\ref{SS:energy_management}.

\textit{Output variable \(y\):} total power consumption - this is output of interest which we will predict using all the above features in the GP model.

\subsection{Structure of  Gaussian Process Models}

For MPC, we require a predictive model for each time step in the horizon.
We learn several GP models, one for each prediction step \( \tau \in \{0,\dots,N-1\}\):
\begin{gather}
\label{E:gp:casestudy}
y_{t+\tau|t} | x_{t+\tau|t} \sim \GaussianDist{\bar{y}_{t+\tau|t}}{\sigma^2_{t+\tau|t}}, \\
x_{t}\!=\![y_{t-l}, \dots, y_{t-1}, u_{t-m}, \dots, u_t, w_{t-p}, \dots, w_{t-1}, w_t], \nonumber
\end{gather}
where \(w:=[d^w, d^p, d^s]\). We assume that at time \(t\), \(w_{t+\tau}\) are available \(\forall \tau \) from forecasts or fixed rules as applicable.

As for the mean and covariance functions to define the structure of GP in \eqref{E:gp:prior}, we use a constant mean \(\mu\) and a kernel function \(k(x,x')\) which is a mixture of constant kernel \(k_1(x,x')\), squared exponential kernel \(k_2(x,x')\) and rational quadratic kernel \(k_3(x,x')\) defined by
\begin{gather}
k_1(x,x')  = k, \nonumber\\
k_2(x,x') = \sigma_{f_2}^2 \exp \left( -\frac{1}{2} \sum_{d=1}^D \frac{(x_d-x_d')}{{\lambda_d^2}}^2 \right),
 \nonumber\\
 k_3(x,x') = \sigma_{f_3}^2  \left( 1+ \frac{1}{2\alpha} \sum_{d=1}^D \frac{(x_d-x_d')}{{\lambda^2}}^2 \right)^{-\alpha},  \nonumber\\
k(x,x') = \left(k_1(x,x') + k_2(x,x')\right)*k_3(x,x').
\end{gather}
Here, \(k_3(x,x')\) is applied to only nontemporal features like time of day and day of week, while \(k_1(x,x')\) and \(k_2(x,x')\) are applied to all the remaining features as proposed in \cite{nghiemetal16gp}. For each model in \eqref{E:gp:casestudy}, we optimize the parameters \(\theta = [\mu, k, \sigma_{f_2}, \lambda_d, \sigma_{f_3}, \alpha, \lambda] \) using GPML \cite{Rasmussen2010}. After training, the less important features, i.e.~features with high \(\lambda_d\) are removed and the models are trained again. We denote this final selection by \(\theta^\star\).

\todo[inline]{model validation?}

\subsection{Optimal Experiment Design}

OED is powerful when hardly any data is available for training. 
To demonstrate this, using Algo.~\ref{A:oed:sequential}, we begin the experiment by assigning \(\GaussianDist{0}{1}\) priors to \(\log (\theta) \) elementwise, except for \(\mu\), since GPML applies gradient descent directly on \(\log \theta\).
For OED, we only require the first model with \(\tau=0\) in \eqref{E:gp:casestudy}. So we simplify the notation by denoting \(t|t\) by \(t\).
Now, the goal at time \(t\) is to determine what should be the optimal cooling set point \(u_{\mathrm{clg},t}\), supply air temperature \(u_{\mathrm{sat},t}\), and chilled water temperature \(u_{\mathrm{chw},t}\) which when applied to the building will require power cnsumption \(y_t\) such that \((x_t,y_t)\) can be used to learn \(\theta\) as efficiently as possible.
We use the lagged terms of the power consumption, proxy variables, weather variables and their lagged terms, fixed schedules and their lagged terms to define \(x_t(u_{\mathrm{clg,t}},u_{\mathrm{sat,t}},u_{\mathrm{chw,t}})\).
In practical situations, the chilled water temperature cannot be changed by more than \(1.5^o\mathrm{C/min}\). We add this constraint accordingly to solve the optimization below every \(15 \mathrm{min}\):
\begin{align}
\label{E:casestudy:oed}
\maximize_{u_{\mathrm{clg},t},u_{\mathrm{sat},t},u_{\mathrm{chw},t}} & \ \ \ \frac{1}{2}\log\left(\frac{\sigma^2_{t}(x_t)+a^T(x_t)\Sigma a(x_t)}{\sigma^2_{t}(x_t)}\right) \\
\st &  \ \ \ \  22^o\mathrm{C} \leq u_{\mathrm{clg,t}} \leq  26^o\mathrm{C} \nonumber \\
&  \ \ \ \  12^o\mathrm{C} \leq u_{\mathrm{sat,t}} \leq  14^o\mathrm{C} \nonumber \\
&  \ \ \ \  3.7^o\mathrm{C} \leq u_{\mathrm{chw,t}} \leq  9.7^o\mathrm{C} \nonumber \\
&  \ \ \ \  | u_{\mathrm{chw},t} - u_{\mathrm{chw},t-1}| \leq  2^o\mathrm{C} \nonumber
\end{align}

\todo[inline]{results}

\subsection{Power Reference Tracking Control}
\label{SS:power_tracking}

This section formulates a model predictive control (MPC) approach for the demand tracking problem.
We consider a building, which responds to various setpoints resulting in power demand variations, and a battery, whose state of charge (SoC) can be measured and whose charge/discharge power can be controlled.
The building's response to the setpoint changes is modeled by a GP.
The battery helps improve the tracking quality by absorbing the prediction uncertainty of the GP.
A controller computes the setpoint values for the building and the power of the battery to optimally track the reference demand signal.
\\

\noindent
\textit{Battery's Model and Constraints:}
For simplicity, we assume an ideal lossless battery model
\begin{equation}
\label{eq:battery-model}
s_{t+1} = s_t + T \Pbatt_t
\end{equation}
where \(\Pbatt_t\) is the battery's power during the time step \(t\) and \(s\) is the battery's SoC.
Here, \(\Pbatt\) is positive if the battery is charging and negative if discharging.
The battery is subject to two operational constraints:
its power must be bounded by \(\Pbmin \leq \Pbatt_t \leq \Pbmax\), 
and its SoC must stay in a safe range \(\SOCmin \leq s_t \leq\SOCmax\) where \(\SOCmax\) is the fully-charged level and \(\SOCmin\) is the lowest safe discharged level. 

The link between the buildings and the battery is the tracking constraint, which states that their total power \(p = y + b\) should track the reference \(r\).
In this way, the battery helps reject the uncertainty of the GP and acts as an energy buffer to increase the tracking capability of the system. Although ideally \(p_t\) should track \(r_t\) exactly at any time \(t\), this strict constraint may be infeasible in certain circumstances, \eg when \(r\) is outside the DR capability of the system.
Therefore, we introduce a slack variable \(\delta_t = r_t - p_t\).
The controller tries to keep \(\delta_t = 0\), however when exact tracking is impossible, it will maintain the operational safety of the system while keeping \(\delta_t\)  as small as possible.
This objective will be reflected in the cost function. 
In this formulation, \(\delta\) is a decision variable  and the battery power is
\begin{equation}
\label{eq:battery-power}
\Pbatt_t = r_t - \delta_t - y_t \text.
\end{equation}


Since \(\GaussianDistSmall{\predict{\tau}{\bar{\Pbatt}}}{\predict{b,\tau}{\sigma^2}}\), the predicted battery power at time \(\tau \geq t\) has the Gaussian distribution \(\predict{\tau}{\Pbatt} \sim 
\GaussianDistSmall{\predict{\tau}{\bar{\Pbatt}}}{\predict{b,\tau}{\sigma^2}}\), where
\begin{equation}
\label{eq:predicted-battery-power}
\predict{\tau}{\bar{\Pbatt}} = r_\tau - \predict{\tau}{\delta} - \predict{\tau}{\bar{y}}, \quad
\predict{b,\tau}{\sigma^2} =  \predict{y,\tau}{\sigma^2} \text.
\end{equation}

The battery's dynamics \eqref{eq:battery-model} result in the future battery's SoC as
\(\predict{\tau+1}{s} = s_t + T \textstyle\sum_{k=t}^\tau (r_k - \predict{k}{\delta}) - T \textstyle\sum_{k=t}^\tau \predict{k}{y}\),
for \(\tau \geq t\).
It follows that \(\predict{\tau+1}{s} \sim \GaussianDistSmall{\predict{\tau+1}{\bar{s}}}{\predict{s,\tau+1}{\sigma^2}}\) where
\begin{equation}
\label{eq:predicted-battery-soc}
\predict{\tau+1}{\bar{s}} = s_t + T \textstyle\sum_{k=t}^\tau \predict{k}{\bar{\Pbatt}}, \,
\predict{s,\tau+1}{\sigma^2} = T^2 \textstyle\sum_{k=t}^\tau \predict{y,k}{\sigma^2} 
\end{equation}
in which Eq.~\eqref{eq:sum-of-power-random-vars} is used to derive the variance.

The bounds on the battery's power and SoC lead to corresponding chance constraints.
We wish to guarantee that at each time step, the power and SoC constraints are satisfied with probability at least \((1 - \epsilon_p)\) and  at least \((1 - \epsilon_s)\), respectively, where \(0 < \epsilon_p, \epsilon_s \leq \frac{1}{2}\) are given constants.
Specifically, for each \(\tau\) in the horizon,
\begin{subequations}\label{eq:chance-constraints}
	\begin{gather}
	\Pr\left( \Pbmin \leq \predict{\tau}{\Pbatt} \leq \Pbmax \right) \geq 1 - \epsilon_p \label{eq:chance-constraints:power} \\
	\Pr\left( \SOCmin \leq \predict{\tau}{s} \leq \SOCmax \right) \geq 1 - \epsilon_s \label{eq:chance-constraints:soc}
	\end{gather}
\end{subequations}
where \(\predict{\tau}{\Pbatt}\) and \(\predict{\tau}{s}\) are Gaussian random variables whose means and variances are given in Eqs.~\eqref{eq:predicted-battery-power} and \eqref{eq:predicted-battery-soc}.


\subsection{Optimizing energy usage under operation constraints}
\label{SS:energy_management}

\todo[inline]{optimization problem}
\begin{figure}[!tb]
	\centering
	\missingfigure[figwidth=20pc]{}
	\caption{}
	\captionsetup{justification=centering}
	\label{F:MPC2}
\end{figure}

\subsection{Active Learning}

\subsection{Discussion}

%\input{truongACC.tex}

